<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>تعبئة رصيد العداد الكهربائي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root{
            --primary:#0066cc; --primary-dark:#004d99; --secondary:#ff6b00;
            --light:#f8f9fa; --dark:#333; --gray:#6c757d; --success:#28a745; --danger:#dc3545;
            --whatsapp: #25D366;
        }
        body{
            background: linear-gradient(135deg,#e6f2ff 0%,#cce5ff 100%);
            color:#333; line-height:1.6; min-height:100vh; padding:20px;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
        }
        .app-container{
            width:100%; max-width:400px; background:white; border-radius:20px;
            box-shadow:0 10px 30px rgba(0,0,0,0.15); overflow:hidden; margin:20px 0;
        }
        header{
            background: linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            color:white; padding:25px 20px; text-align:center; position:relative;
        }
        .logo-container{ display:flex; justify-content:center; align-items:center; margin-bottom:15px; }
        .logo{ width:70px; height:70px; background:white; border-radius:50%; display:flex; justify-content:center; align-items:center; margin-left:15px; box-shadow:0 5px 15px rgba(0,0,0,0.2); }
        .logo i{ font-size:35px; color:var(--primary); }
        h1{ font-size:22px; margin:10px 0 5px; }
        .subtitle{ font-size:14px; opacity:0.9; }
        .main-menu{ padding:20px; }
        .form-container{ padding:20px; }
        .form-group{ margin-bottom:20px; position:relative; }
        label{ display:block; margin-bottom:8px; font-weight:600; color:var(--primary-dark); }
        input, select, button { width:100%; padding:15px; border:1px solid #ddd; border-radius:10px; font-size:16px; }
        input:focus, select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 2px rgba(0,102,204,0.2); }
        .meter-input-container{ position:relative; }
        .validation-icon{ position:absolute; left:15px; top:50%; transform:translateY(-50%); font-size:18px; }
        .validation-icon.valid{ color:var(--success); }
        .validation-icon.invalid{ color:var(--danger); }
        .error-message{ color:var(--danger); font-size:12px; margin-top:5px; display:none; }
        .payment-options{ display:grid; grid-template-columns:1fr 1fr; gap:15px; margin:20px 0; }
        .payment-option{ background:var(--light); border:2px solid #ddd; border-radius:15px; padding:15px; text-align:center; cursor:pointer; transition:all 0.3s; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .payment-option.active{ border-color:var(--primary); background:#e6f2ff; box-shadow:0 5px 15px rgba(0,0,0,0.1); transform:translateY(-5px); }
        .payment-icon{ width:80px; height:80px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; overflow:hidden; background:white; padding:5px; }
        .payment-icon img{ width:100%; height:100%; object-fit:contain; }
        .payment-option h3{ font-size:16px; margin-bottom:5px; }
        .payment-option p{ font-size:12px; color:var(--gray); }
        .btn{ background: linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%); color:white; border:none; padding:16px; font-size:18px; font-weight:600; border-radius:10px; cursor:pointer; transition:all 0.3s; display:flex; justify-content:center; align-items:center; margin-top:10px; }
        .btn i{ margin-left:8px; }
        .btn:hover{ background: linear-gradient(135deg,var(--primary-dark) 0%,#003366 100%); transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled{ background:#ccc; cursor:not-allowed; transform:none; box-shadow:none; }
        .btn-whatsapp{ background: linear-gradient(135deg, var(--whatsapp) 0%, #128C7E 100%); }
        .btn-whatsapp:hover{ background: linear-gradient(135deg, #128C7E 0%, #075E54 100%); }
        .back-button{ position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.2); width:40px; height:40px; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer; }
        .hidden{ display:none; }
        footer{ text-align:center; padding:15px; color:var(--gray); font-size:14px; margin-top:auto; display:flex; flex-direction:column; align-items:center; gap:6px; }
        .amount-notice{ background:#e6f2ff; border:1px solid var(--primary); border-radius:8px; padding:10px; margin:10px 0; font-size:13px; text-align:center; color:var(--primary-dark); }
        .fee-notice{ background:#fff3cd; border:1px solid #ffeaa7; border-radius:8px; padding:12px; margin:15px 0; font-size:13px; text-align:center; color:#856404; }
        .amount-details{ background:#f8f9fa; border-radius:8px; padding:12px; margin-top:10px; font-size:14px; }
        .amount-breakdown{ display:flex; justify-content:space-between; margin-bottom:5px; }
        .final-amount{ font-weight:bold; color:var(--primary); border-top:1px solid #ddd; padding-top:8px; margin-top:8px; }
        .instructions{ background:#e6f2ff; padding:15px; border-radius:10px; margin-bottom:20px; border-right:4px solid var(--primary); }
        .instructions h3{ color:var(--primary); margin-bottom:10px; }
        .instructions ol{ padding-right:20px; }
        .instructions li{ margin-bottom:8px; font-size:14px; }
        .transaction-status{ padding:15px; border-radius:10px; margin:15px 0; text-align:center; display:none; }
        .status-success{ background:#d4edda; border:1px solid #28a745; color:#155724; }
        .status-error{ background:#f8d7da; border:1px solid #dc3545; color:#721c24; }
        .status-processing{ background:#e6f2ff; border:1px solid #0066cc; color:#004085; }
        .confirmation-page{ padding:20px; text-align:center; }
        .confirmation-input{ font-size:24px; text-align:center; letter-spacing:10px; font-weight:bold; }
        .review-box{ background:#f1f7ff; border:1px solid #d7eaff; border-radius:8px; padding:12px; margin-top:10px; font-size:14px; }
        .support-line{ font-size:14px; color:var(--gray); }
        .success-page{ padding:30px 20px; text-align:center; }
        .success-icon{ width:80px; height:80px; background:var(--success); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; }
        .success-icon i{ font-size:40px; color:white; }
        .whatsapp-success-icon{ width:80px; height:80px; background:var(--whatsapp); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; }
        .whatsapp-success-icon i{ font-size:40px; color:white; }
        .success-message{ margin:20px 0; }
        .whatsapp-button-container{ margin-top: 30px; }
        @media (max-width:480px){
            .app-container{ border-radius:15px; }
            header{ padding:20px 15px; }
            h1{ font-size:20px; }
            .form-container{ padding:15px; }
            .payment-icon{ width:70px; height:70px; }
            input, button{ font-size:15px; padding:12px; }
            .btn{ font-size:16px; padding:12px; }
            .payment-option{ padding:10px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- الصفحة الرئيسية -->
        <header>
            <div class="back-button hidden" id="backButton" title="عودة">
                <i class="fas fa-arrow-right"></i>
            </div>
            <div class="logo-container">
                <div class="logo"><i class="fas fa-bolt"></i></div>
                <div>
                    <h1>شحن الرصيد الكهربائي</h1>
                    <p class="subtitle">اختر طريقة الدفع المناسبة</p>
                </div>
            </div>
        </header>

        <div class="main-menu" id="mainMenu">
            <div class="instructions">
                <h3>تعليمات الاستخدام:</h3>
                <ol>
                    <li>أدخل رقم العداد الخاص بك (13 رقماً)</li>
                    <li>اختر طريقة الدفع المناسبة</li>
                    <li>املأ بيانات الدفع</li>
                    <li>سيتم إرسال طلبك عبر واتساب تلقائياً</li>
                </ol>
            </div>

            <div class="form-group">
                <label for="meterNumber">رقم العداد</label>
                <div class="meter-input-container">
                    <input type="text" id="meterNumber" placeholder="أدخل 13 رقماً بدون مسافات" maxlength="13" inputmode="numeric" pattern="[0-9]{13}" required>
                    <div class="validation-icon hidden" id="meterValidationIcon"></div>
                </div>
                <div class="error-message" id="meterError">❌ رقم العداد يجب أن يكون 13 رقماً ويبدأ بـ 02680</div>
            </div>

            <h3 style="margin-bottom:15px; text-align:center; color:var(--primary);">اختر طريقة الدفع:</h3>

            <div class="payment-options">
                <div class="payment-option" data-method="adfa3ly">
                    <div class="payment-icon">
                        <img src="https://raw.githubusercontent.com/Alsanoce/Jebaya/refs/heads/main/images/adfa3ly.png" alt="أدفع لي" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iMTIiIGZpbGw9IiMwMDY2Q0MiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxyZWN0IHg9IjIiIHk9IjUiIHdpZHRoPSIyMCIgaGVpZ2h0PSIxNCIgcng9IjIiLz4KPHBhdGggZD0iTTIgMTVoMjAiLz4KPHBhdGggZD0iTTkgOWg2Ii8+Cjwvc3ZnPgo8L3N2Zz4K'">
                    </div>
                    <h3>أدفع لي</h3>
                    <p>الدفع عبر رقم الهاتف</p>
                </div>

                <div class="payment-option" data-method="mobicash">
                    <div class="payment-icon">
                        <img src="https://raw.githubusercontent.com/Alsanoce/Jebaya/refs/heads/main/images/mobicash.png" alt="موبي كاش" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iMTIiIGZpbGw9IiMwMDY2Q0MiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxyZWN0IHg9IjQiIHk9IjQiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgcng9IjIiLz4KPHBhdGggZD0iTTkgMTJoNiIvPgo8cGF0aCBkPSJNMTIgOXY2Ii8+Cjwvc3ZnPgo8L3N2Zz4K'">
                    </div>
                    <h3>موبي كاش</h3>
                    <p>الدفع عبر البطاقة</p>
                </div>
            </div>

            <button class="btn" id="continueButton" disabled><i class="fas fa-arrow-left"></i> استمرار</button>
        </div>

        <!-- صفحة أدفع لي -->
        <div class="form-container hidden" id="adfa3lyForm">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--primary);">الدفع عبر أدفع لي</h2>

            <div class="fee-notice"><i class="fas fa-info-circle"></i> <span>أدخل بيانات العميل لإتمام عملية الشحن</span></div>
            <div class="amount-notice"><i class="fas fa-exclamation-circle"></i> <span>أقل قيمة للتعبئة 30 دينار</span></div>

            <div class="form-group">
              <label for="customerMobile">رقم هاتف العميل</label>
                <input type="text" id="customerMobile" placeholder=" 09xxxxxxxx" required>
                <small style="color:var(--gray); font-size:12px;">رقم هاتف العميل المسجل في البنك</small>
            </div>

            <div class="form-group">
                <label for="amountAdfa3ly">المبلغ (دينار)</label>
                <input type="number" id="amountAdfa3ly" placeholder="أدخل المبلغ (30 دينار كحد أدنى)" min="30" required>
                <div class="amount-details hidden" id="amountDetailsAdfa3ly">
                    <div class="amount-breakdown"><span>المبلغ المدخل:</span><span id="enteredAmountAdfa3ly">0</span> دينار</div>
                    <div class="amount-breakdown"><span>قيمة الخدمة (<span id="feePercentageAdfa3ly">0</span>%):</span><span id="serviceFeeAdfa3ly">0</span> دينار</div>
                    <div class="amount-breakdown final-amount"><span>المبلغ الفعلي:</span><span id="finalAmountAdfa3ly">0</span> دينار</div>
                </div>
                <div class="review-box hidden" id="reviewBoxAdfa3ly"></div>
            </div>

            <div class="transaction-status" id="transactionStatus"><i class="fas fa-sync-alt fa-spin"></i> <span id="statusMessage">جاري معالجة الطلب...</span></div>

            <button class="btn" id="initiatePayment"><i class="fas fa-play-circle"></i> بدء عملية الدفع</button>
        </div>

        <!-- صفحة تأكيد رمز التحقق -->
        <div class="confirmation-page hidden" id="confirmationPage">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--primary);">تأكيد العملية</h2>
            
            <div class="success-icon" style="background:#e6f2ff; margin-bottom:15px;">
                <i class="fas fa-mobile-alt" style="color:var(--primary); font-size:35px;"></i>
            </div>
            
            <h3 style="color:var(--primary); margin-bottom:15px;">تم إرسال رمز التحقق</h3>
            <p style="margin-bottom:25px; color:var(--gray);">تم إرسال رمز التحقق المكون من 4 أرقام إلى هاتف العميل</p>

            <div class="form-group">
                <label for="confirmationPin">رمز التحقق (4 أرقام)</label>
                <input type="text" id="confirmationPin" class="confirmation-input" placeholder="____" maxlength="4" inputmode="numeric">
            </div>

            <div class="transaction-status" id="confirmationStatus"></div>

            <button class="btn" id="confirmTransaction"><i class="fas fa-check-circle"></i> تأكيد العملية</button>
        </div>

        <!-- صفحة النجاح -->
        <div class="success-page hidden" id="successPage">
            <div class="whatsapp-success-icon">
                <i class="fab fa-whatsapp"></i>
            </div>
            
            <h2 style="color:var(--whatsapp); margin-bottom:15px;">تمت العملية بنجاح!</h2>
            
            <div class="success-message">
                <p style="margin-bottom:20px; color:var(--gray);">تم شحن الرصيد الكهربائي بنجاح</p>
                <p style="margin-bottom:20px; color:var(--gray);">انقر على الزر أدناه لاستلام التفاصيل على واتساب</p>
            </div>

            <div class="review-box" id="successDetails" style="margin:20px 0;"></div>

            <div class="whatsapp-button-container">
                <button class="btn btn-whatsapp" id="whatsappButton">
                    <i class="fab fa-whatsapp"></i> استلام التفاصيل على واتساب
                </button>
            </div>
        </div>

        <!-- موبي كاش -->
        <div class="form-container hidden" id="mobicashForm">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--primary);">الدفع عبر موبي كاش</h2>

            <div class="fee-notice"><i class="fas fa-info-circle"></i> <span>سيتم تحويلك إلى بوابة الدفع لإتمام العملية</span></div>
            <div class="amount-notice"><i class="fas fa-exclamation-circle"></i> <span>أقل قيمة للتعبئة 30 دينار</span></div>

            <!-- 🔹 رقم الهاتف -->
            <div class="form-group">
                <label for="mobicashMobile">رقم الهاتف</label>
                <input type="text" id="mobicashMobile" placeholder="09xxxxxxxx" maxlength="10" inputmode="numeric" required>
                <small style="color:var(--gray); font-size:12px;">أدخل رقم الهاتف المرتبط بحساب موبي كاش</small>
            </div>

            <!-- 🔹 رقم البطاقة -->
            <div class="form-group">
                <label for="cardNumber">رقم البطاقة</label>
                <input type="text" id="cardNumber" placeholder="أدخل رقم البطاقة" required>
            </div>

            <!-- 🔹 المبلغ -->
            <div class="form-group">
                <label for="amountMobicash">المبلغ (دينار)</label>
                <input type="number" id="amountMobicash" placeholder="أدخل المبلغ (30 دينار كحد أدنى)" min="30" required>
                <div class="amount-details hidden" id="amountDetailsMobicash">
                    <div class="amount-breakdown"><span>المبلغ المدخل:</span><span id="enteredAmountMobicash">0</span> دينار</div>
                    <div class="amount-breakdown"><span>قيمة الخدمة (<span id="feePercentageMobicash">0</span>%):</span><span id="serviceFeeMobicash">0</span> دينار</div>
                    <div class="amount-breakdown final-amount"><span>المبلغ الفعلي:</span><span id="finalAmountMobicash">0</span> دينار</div>
                </div>
            </div>

            <div class="review-box" id="reviewBoxMobicash" style="display:none;"></div>

            <div class="transaction-status" id="mobicashStatus"></div>

            <button class="btn" id="submitMobicash"><i class="fab fa-whatsapp"></i> إرسال الطلب عبر واتساب</button>
        </div>
    </div>

    <footer>
        <div>© 2025 نظام شحن الرصيد الكهربائي. جميع الحقوق محفوظة.</div>
        <div class="support-line">📞 الدعم الفني: <a href="https://wa.me/218942381395" target="_blank" rel="noopener" style="color:var(--primary); text-decoration:none;">واتساب 0942381395</a></div>
    </footer>

    <script>
    // ======================
    // خدمة Google Apps Script الحقيقية
    // ======================
    class BankPaymentService {
        constructor() {
            // رابط Google Apps Script الحقيقي
            this.scriptURL = 'https://script.google.com/macros/s/AKfycbwjOZkmRVImTvFDC4ITUChRaJS5FaJl6qNcHU4WVenrpLxFkifA7Y6xMebCGFKCjUJ7/exec';
        }

        // دالة الاتصال الرئيسية مع JSONP
        async callGoogleScript(action, data = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(999999 * Math.random());
                const script = document.createElement('script');
                
                let url = `${this.scriptURL}?callback=${callbackName}&action=${action}`;
                
                // إضافة جميع معاملات البيانات إلى URL
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        url += `&${encodeURIComponent(key)}=${encodeURIComponent(data[key])}`;
                    }
                });

                console.log(`📤 إرسال طلب ${action} إلى:`, url);

                script.src = url;
                
                window[callbackName] = (response) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (response && response.success) {
                        resolve(response);
                    } else {
                        reject(new Error(response?.error || 'خطأ في الاستجابة من الخادم'));
                    }
                };

                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('فشل في تحميل السكريبت - تأكد من اتصال الإنترنت'));
                };

                document.body.appendChild(script);
                
                // timeout بعد 30 ثانية
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        reject(new Error('انتهت مهلة الاتصال بالخادم'));
                    }
                }, 30000);
            });
        }

        async doPTrans(customerMobile, amount) {
            console.log('🚀 بدء DoPTrans:', { customerMobile, amount });
            
            try {
                const result = await this.callGoogleScript('doPTrans', {
                    customerMobile: customerMobile,
                    amount: amount
                });
                
                console.log('✅ نتيجة DoPTrans:', result);
                return result.data;
                
            } catch (error) {
                console.error('❌ خطأ في DoPTrans:', error);
                throw error;
            }
        }

        async onlineConfTrans(sessionID, confirmationPin) {
            console.log('🔐 بدء OnlineConfTrans:', { sessionID, confirmationPin });
            
            try {
                const result = await this.callGoogleScript('onlineConfTrans', {
                    sessionID: sessionID,
                    confirmationPin: confirmationPin
                });
                
                console.log('✅ نتيجة OnlineConfTrans:', result);
                return result.data;
                
            } catch (error) {
                console.error('❌ خطأ في OnlineConfTrans:', error);
                throw error;
            }
        }

        async saveToSheets(data) {
            console.log('💾 حفظ في Sheets:', data);
            
            try {
                const result = await this.callGoogleScript('saveToSheets', data);
                console.log('✅ تم الحفظ:', result);
                return result;
            } catch (error) {
                console.error('❌ خطأ في الحفظ:', error);
                throw error;
            }
        }
    }

    // ======================
    // المكوّن الرئيسي للواجهة
    // ======================
    document.addEventListener('DOMContentLoaded', function() {
        const mainMenu = document.getElementById('mainMenu');
        const adfa3lyForm = document.getElementById('adfa3lyForm');
        const mobicashForm = document.getElementById('mobicashForm');
        const confirmationPage = document.getElementById('confirmationPage');
        const successPage = document.getElementById('successPage');
        const backButton = document.getElementById('backButton');
        const continueButton = document.getElementById('continueButton');
        const meterNumberInput = document.getElementById('meterNumber');
        const meterValidationIcon = document.getElementById('meterValidationIcon');
        const meterError = document.getElementById('meterError');

        // استخدام الخدمة الحقيقية
        const bankService = new BankPaymentService();
        
        let currentSessionID = null;
        let selectedMethod = null;
        let isMeterValid = false;
        let currentTransactionData = null;

        const SUPPORT_PHONE_PLAIN = '218942381395';
        const SUPPORT_PHONE_DISPLAY = '0942381395';

        // ======= دوال مساعدة عامة =======
        function setStatus(type, message, elementId = 'transactionStatus') {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = `transaction-status status-${type}`;
            const iconClass = (type === 'processing') ? 'sync-alt fa-spin' : (type === 'success' ? 'check-circle' : 'times-circle');
            el.innerHTML = `<i class="fas fa-${iconClass}"></i> <span id="statusMessage">${message}</span>`;
        }

        function clearStatus(elementId = 'transactionStatus') {
            const el = document.getElementById(elementId);
            el.style.display = 'none';
            el.className = 'transaction-status';
            el.innerHTML = '';
        }

        function showPage(page) {
            mainMenu.classList.add('hidden');
            adfa3lyForm.classList.add('hidden');
            mobicashForm.classList.add('hidden');
            confirmationPage.classList.add('hidden');
            successPage.classList.add('hidden');
            
            page.classList.remove('hidden');
            
            if (page !== mainMenu) {
                backButton.classList.remove('hidden');
            } else {
                backButton.classList.add('hidden');
            }
        }

        function formatLibyanPhone(phoneRaw) {
            if (!phoneRaw) return '';
            let num = phoneRaw.replace(/\D/g,'');
            
            // تحويل إلى صيغة +2189xxxxxxxx
            if (num.startsWith('0') && !num.startsWith('218')) {
                num = num.replace(/^0+/, '');
            }
            if (num.length === 9 && num.startsWith('9')) {
                return '+218' + num;
            }
            if (num.length === 12 && num.startsWith('218')) {
                return '+' + num;
            }
            if (num.startsWith('+')) return num;
            if (num.length === 10 && num.startsWith('09')) {
                return '+218' + num.substring(1);
            }
            return (num.length > 0 && !num.startsWith('+')) ? ('+' + num) : num;
        }

        function calculateServiceFee(amount) {
            let feePercentage = 10;
            if (amount >= 100) feePercentage = 5;
            const serviceFee = (amount * feePercentage) / 100;
            const finalAmount = amount + serviceFee;
            return { feePercentage, serviceFee: Math.round(serviceFee * 100) / 100, finalAmount: Math.round(finalAmount * 100) / 100 };
        }

        function showReviewAdfa3ly(mobile, amount) {
            const box = document.getElementById('reviewBoxAdfa3ly');
            const calc = calculateServiceFee(amount);
            box.innerHTML = `
                <b>ملخص الدفع:</b><br>
                • رقم العداد: ${document.getElementById('meterNumber').value}<br>
                • رقم العميل: ${mobile}<br>
                • المبلغ: ${amount} د.ل<br>
                • رسوم الخدمة: ${calc.serviceFee} د.ل (${calc.feePercentage}%)<br>
                • إجمالي الدفع: ${calc.finalAmount} د.ل
            `;
            box.classList.remove('hidden');
        }

        function showReviewMobicash(mobile, cardNumber, amount) {
            const box = document.getElementById('reviewBoxMobicash');
            const calc = calculateServiceFee(amount);
            box.innerHTML = `
                <b>ملخص الدفع:</b><br>
                • رقم العداد: ${document.getElementById('meterNumber').value}<br>
                • رقم الهاتف: ${mobile}<br>
                • رقم البطاقة: ${cardNumber ? '••••' + cardNumber.slice(-4) : 'لم يُدخل'}<br>
                • المبلغ: ${amount} د.ل<br>
                • رسوم الخدمة: ${calc.serviceFee} د.ل (${calc.feePercentage}%)<br>
                • إجمالي الدفع: ${calc.finalAmount} د.ل
            `;
            box.style.display = 'block';
        }

        function hideReviewAdfa3ly() {
            const box = document.getElementById('reviewBoxAdfa3ly');
            box.classList.add('hidden');
            box.innerHTML = '';
        }

        function hideReviewMobicash() {
            const box = document.getElementById('reviewBoxMobicash');
            box.style.display = 'none';
            box.innerHTML = '';
        }

        // ======= تحقق رقم العداد =======
        function validateMeterNumber(number) {
            if (!number) return false;
            if (number.length !== 13) return false;
            if (!/^\d{13}$/.test(number)) return false;
            if (!number.startsWith('02680')) return false;
            return true;
        }

        // أحداث الإدخال لرقم العداد
        meterNumberInput.addEventListener('input', function() {
            const value = this.value.replace(/\D/g,'');
            this.value = value;
            isMeterValid = validateMeterNumber(this.value);
            if (this.value.length > 0) {
                meterValidationIcon.classList.remove('hidden');
                if (isMeterValid) {
                    meterValidationIcon.className = 'validation-icon valid';
                    meterValidationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                    meterError.style.display = 'none';
                } else {
                    meterValidationIcon.className = 'validation-icon invalid';
                    meterValidationIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                    meterError.style.display = 'block';
                }
            } else {
                meterValidationIcon.classList.add('hidden');
                meterError.style.display = 'none';
            }
            updateContinueButton();
        });

        function updateContinueButton() {
            continueButton.disabled = !(isMeterValid && selectedMethod);
        }

        // اختيار طريقة الدفع
        const paymentOptions = document.querySelectorAll('.payment-option');
        paymentOptions.forEach(option => {
            option.addEventListener('click', function() {
                paymentOptions.forEach(op => op.classList.remove('active'));
                this.classList.add('active');
                selectedMethod = this.dataset.method;
                updateContinueButton();
                
                console.log('تم اختيار طريقة الدفع:', selectedMethod);
            });
        });

        // زر استمرار
        continueButton.addEventListener('click', function() {
            if (!isMeterValid) { 
                alert('يرجى إدخال رقم عداد صحيح'); 
                return; 
            }
            if (!selectedMethod) { 
                alert('يرجى اختيار طريقة الدفع'); 
                return; 
            }
            
            console.log('الانتقال إلى:', selectedMethod);
            
            if (selectedMethod === 'adfa3ly') {
                showPage(adfa3lyForm);
            } else if (selectedMethod === 'mobicash') {
                showPage(mobicashForm);
            }
        });

        // زر رجوع
        backButton.addEventListener('click', function() {
            showPage(mainMenu);
            resetTransactionUI();
            hideReviewAdfa3ly();
            hideReviewMobicash();
        });

        // تحديث الملخص عند تغيير المبلغ في أدفع لي
        document.getElementById('amountAdfa3ly').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            if (amount >= 30) {
                document.getElementById('enteredAmountAdfa3ly').textContent = amount;
                const calc = calculateServiceFee(amount);
                document.getElementById('feePercentageAdfa3ly').textContent = calc.feePercentage;
                document.getElementById('serviceFeeAdfa3ly').textContent = calc.serviceFee;
                document.getElementById('finalAmountAdfa3ly').textContent = calc.finalAmount;
                document.getElementById('amountDetailsAdfa3ly').classList.remove('hidden');

                const formattedMobile = formatLibyanPhone(document.getElementById('customerMobile').value);
                showReviewAdfa3ly(formattedMobile, amount);
            } else {
                document.getElementById('amountDetailsAdfa3ly').classList.add('hidden');
                hideReviewAdfa3ly();
            }
        });

        // تحديث الملخص عند تغيير رقم العميل أيضاً
        document.getElementById('customerMobile').addEventListener('input', function() {
            const amount = parseFloat(document.getElementById('amountAdfa3ly').value) || 0;
            if (amount >= 30) {
                const formattedMobile = formatLibyanPhone(this.value);
                showReviewAdfa3ly(formattedMobile, amount);
            }
        });

        // تحديث الملخص عند تغيير المبلغ في موبي كاش
        document.getElementById('amountMobicash').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            if (amount >= 30) {
                document.getElementById('enteredAmountMobicash').textContent = amount;
                const calc = calculateServiceFee(amount);
                document.getElementById('feePercentageMobicash').textContent = calc.feePercentage;
                document.getElementById('serviceFeeMobicash').textContent = calc.serviceFee;
                document.getElementById('finalAmountMobicash').textContent = calc.finalAmount;
                document.getElementById('amountDetailsMobicash').classList.remove('hidden');

                const mobicashMobile = document.getElementById('mobicashMobile').value;
                const cardNumber = document.getElementById('cardNumber').value;
                showReviewMobicash(mobicashMobile, cardNumber, amount);
            } else {
                document.getElementById('amountDetailsMobicash').classList.add('hidden');
                hideReviewMobicash();
            }
        });

        // تحديث الملخص عند تغيير رقم الهاتف أو البطاقة في موبي كاش
        document.getElementById('mobicashMobile').addEventListener('input', updateMobicashReview);
        document.getElementById('cardNumber').addEventListener('input', updateMobicashReview);

        function updateMobicashReview() {
            const amount = parseFloat(document.getElementById('amountMobicash').value) || 0;
            if (amount >= 30) {
                const mobicashMobile = document.getElementById('mobicashMobile').value;
                const cardNumber = document.getElementById('cardNumber').value;
                showReviewMobicash(mobicashMobile, cardNumber, amount);
            }
        }

        // بدء عملية الدفع لأدفع لي
        document.getElementById('initiatePayment').addEventListener('click', async function() {
            const meterNumber = document.getElementById('meterNumber').value;
            const customerMobileRaw = document.getElementById('customerMobile').value;
            const customerMobile = formatLibyanPhone(customerMobileRaw);
            const amountInput = document.getElementById('amountAdfa3ly').value;
            const originalAmount = parseFloat(amountInput);

            if (!customerMobileRaw) { 
                alert('يرجى إدخال رقم هاتف العميل'); 
                return; 
            }
            if (!originalAmount || originalAmount < 30) { 
                alert('يرجى إدخال مبلغ صحيح لا يقل عن 30 دينار'); 
                return; 
            }

            if (!customerMobile.startsWith('+218') || customerMobile.length < 12) {
                alert('رقم الهاتف يجب أن يكون رقم ليبي صالح (09xxxxxxxx)');
                return;
            }

            const calc = calculateServiceFee(originalAmount);
            const totalAmount = calc.finalAmount;

            currentTransactionData = {
                meterNumber,
                customerMobile,
                originalAmount,
                serviceFee: calc.serviceFee,
                totalAmount,
                feePercentage: calc.feePercentage
            };

            setStatus('processing', 'جاري الاتصال بخادم الدفع...');
            this.disabled = true;

            try {
                // حفظ البيانات أولاً
                await bankService.saveToSheets({
                    meterNumber,
                    paymentMethod: 'أدفع لي',
                    customerMobile,
                    originalAmount: originalAmount,
                    serviceFee: calc.serviceFee,
                    totalAmount: totalAmount,
                    status: 'initiated',
                    notes: 'بدء عملية الدفع'
                });

                // استدعاء DoPTrans
                const result = await bankService.doPTrans(customerMobile, totalAmount);
                
                console.log('✅ نتيجة DoPTrans:', result);
                
                currentSessionID = result;
                
                // حفظ النتيجة
                await bankService.saveToSheets({
                    meterNumber,
                    paymentMethod: 'أدفع لي',
                    customerMobile,
                    originalAmount: originalAmount,
                    serviceFee: calc.serviceFee,
                    totalAmount: totalAmount,
                    status: 'pending',
                    sessionID: result,
                    notes: 'تم إنشاء الجلسة - في انتظار التأكيد'
                });

                showPage(confirmationPage);
                clearStatus();
                this.disabled = false;

            } catch (error) {
                const errMsg = (error && error.message) ? error.message : 'خطأ غير معروف';
                
                console.error('❌ خطأ في DoPTrans:', errMsg);

                // حفظ الفشل
                try {
                    await bankService.saveToSheets({
                        meterNumber,
                        paymentMethod: 'أدفع لي',
                        customerMobile,
                        originalAmount: originalAmount,
                        serviceFee: calc.serviceFee,
                        totalAmount: totalAmount,
                        status: 'failed',
                        sessionID: currentSessionID || '',
                        notes: `خطأ أثناء DoPTrans: ${errMsg}`
                    });
                } catch (saveErr) {
                    console.warn('❌ فشل في حفظ الفشل:', saveErr);
                }

                let userMessage = 'حدث خطأ أثناء المعالجة';
                
                if (errMsg.includes('ACC')) {
                    userMessage = 'رقم الهاتف غير مسجل في نظام الدفع';
                } else if (errMsg.includes('رصيد')) {
                    userMessage = 'رصيد غير كافي في حساب الدفع';
                } else if (errMsg.includes('فشل في الاتصال')) {
                    userMessage = 'تعذر الاتصال بخادم الدفع. يرجى المحاولة لاحقاً';
                } else if (errMsg.includes('PW') || errMsg.includes('Pin')) {
                    userMessage = 'بيانات الدخول غير صحيحة';
                }

                setStatus('error', userMessage);
                this.disabled = false;
            }
        });

        // تأكيد العملية (OnlineConfTrans)
        document.getElementById('confirmTransaction').addEventListener('click', async function() {
            const confirmationPin = document.getElementById('confirmationPin').value;

            if (!confirmationPin || confirmationPin.length !== 4) { 
                alert('يرجى إدخال رمز التحقق المكون من 4 أرقام'); 
                return; 
            }

            if (!/^\d{4}$/.test(confirmationPin)) {
                alert('يجب أن يتكون رمز التحقق من أرقام فقط');
                return;
            }

            setStatus('processing', 'جاري تأكيد العملية...', 'confirmationStatus');
            this.disabled = true;

            try {
                const result = await bankService.onlineConfTrans(currentSessionID, confirmationPin);

                console.log('✅ نتيجة التأكيد:', result);

                if (result === 'OK' || result === 'Success') {
                    
                    await bankService.saveToSheets({
                        meterNumber: currentTransactionData.meterNumber,
                        paymentMethod: 'أدفع لي',
                        customerMobile: currentTransactionData.customerMobile,
                        originalAmount: currentTransactionData.originalAmount,
                        serviceFee: currentTransactionData.serviceFee,
                        totalAmount: currentTransactionData.totalAmount,
                        status: 'completed',
                        sessionID: currentSessionID,
                        notes: 'تم التأكيد بنجاح'
                    });

                    const successDetails = `
                        <b>تفاصيل المعاملة الناجحة:</b><br>
                        • رقم العداد: ${currentTransactionData.meterNumber}<br>
                        • طريقة الدفع: أدفع لي<br>
                        • رقم الزبون: ${currentTransactionData.customerMobile}<br>
                        • المبلغ الأصلي: ${currentTransactionData.originalAmount} د.ل<br>
                        • قيمة الخدمة: ${currentTransactionData.serviceFee} د.ل (${currentTransactionData.feePercentage}%)<br>
                        • إجمالي الدفع: ${currentTransactionData.totalAmount} د.ل<br>
                        • وقت التنفيذ: ${new Date().toLocaleString('ar-LY')}
                    `;
                    
                    document.getElementById('successDetails').innerHTML = successDetails;

                    showPage(successPage);

                } else {
                    setStatus('error', `فشل في التأكيد: ${result}`, 'confirmationStatus');
                    this.disabled = false;
                }

            } catch (error) {
                const errMsg = (error && error.message) ? error.message : 'خطأ غير معروف أثناء التأكيد';
                console.error('❌ خطأ في التأكيد:', errMsg);
                
                try {
                    await bankService.saveToSheets({
                        meterNumber: currentTransactionData.meterNumber,
                        paymentMethod: 'أدفع لي',
                        customerMobile: currentTransactionData.customerMobile,
                        originalAmount: currentTransactionData.originalAmount,
                        serviceFee: currentTransactionData.serviceFee,
                        totalAmount: currentTransactionData.totalAmount,
                        status: 'failed',
                        sessionID: currentSessionID || '',
                        notes: `خطأ أثناء OnlineConfTrans: ${errMsg}`
                    });
                } catch (saveErr) {
                    console.warn('❌ فشل في حفظ الفشل:', saveErr);
                }

                let userMessage = 'حدث خطأ أثناء التأكيد';
                
                if (errMsg.includes('رمز التحقق')) {
                    userMessage = 'رمز التحقق غير صحيح';
                } else if (errMsg.includes('فشل في الاتصال')) {
                    userMessage = 'تعذر الاتصال بخادم الدفع';
                } else if (errMsg.includes('Invalid') || errMsg.includes('Fail')) {
                    userMessage = 'رمز التحقق غير صحيح أو انتهت صلاحية الجلسة';
                }

                setStatus('error', userMessage, 'confirmationStatus');
                this.disabled = false;
            }
        });

        // زر إرسال التفاصيل على واتساب
        document.getElementById('whatsappButton').addEventListener('click', function() {
            const whatsappText = encodeURIComponent(
`✅ تمت عملية شحن الرصيد الكهربائي بنجاح

📋 تفاصيل المعاملة:
───────────────
• رقم العداد: ${currentTransactionData.meterNumber}
• طريقة الدفع: أدفع لي
• رقم الزبون: ${currentTransactionData.customerMobile}
• المبلغ الأصلي: ${currentTransactionData.originalAmount} د.ل
• قيمة الخدمة: ${currentTransactionData.serviceFee} د.ل (${currentTransactionData.feePercentage}%)
• إجمالي الدفع: ${currentTransactionData.totalAmount} د.ل
• رقم الجلسة: ${currentSessionID}
• وقت التنفيذ: ${new Date().toLocaleString('ar-LY')}
-----------------
🎉 تمت العملية بنجاح - شكراً لاستخدامكم خدماتنا`
            );

            window.open(`https://api.whatsapp.com/send?phone=${SUPPORT_PHONE_PLAIN}&text=${whatsappText}`, '_blank');
        });

        // إرسال موبي كاش -> فتح واتساب
        document.getElementById('submitMobicash').addEventListener('click', async function() {
            const meterNumber = document.getElementById('meterNumber').value;
            const mobicashMobile = document.getElementById('mobicashMobile').value;
            const cardNumber = document.getElementById('cardNumber').value.trim();
            const amountInput = document.getElementById('amountMobicash').value;
            const originalAmount = parseFloat(amountInput);

            if (!mobicashMobile) { alert('يرجى إدخال رقم الهاتف'); return; }
            if (!cardNumber) { alert('يرجى إدخال رقم البطاقة'); return; }
            if (!originalAmount || originalAmount < 30) { alert('يرجى إدخال مبلغ صحيح لا يقل عن 30 دينار'); return; }

            const calc = calculateServiceFee(originalAmount);
            const totalAmount = calc.finalAmount;

            currentTransactionData = {
                meterNumber,
                customerMobile: mobicashMobile,
                cardNumber,
                originalAmount,
                serviceFee: calc.serviceFee,
                totalAmount,
                feePercentage: calc.feePercentage,
                paymentMethod: 'موبي كاش'
            };

            try {
                await bankService.saveToSheets({
                    meterNumber,
                    paymentMethod: 'موبي كاش',
                    customerMobile: mobicashMobile,
                    cardNumber,
                    originalAmount: originalAmount,
                    serviceFee: calc.serviceFee,
                    totalAmount: totalAmount,
                    status: 'pending',
                    sessionID: '',
                    notes: 'تم إرسال طلب موبي كاش - انتظار معالجة يدوية'
                });
            } catch (err) {
                console.warn('❌ فشل في حفظ موبي كاش:', err);
            }

            const whatsappMessage = `طلب شحن رصيد كهربائي (موبي كاش)

📋 تفاصيل الطلب:
───────────────
• رقم العداد: ${meterNumber}
• طريقة الدفع: موبي كاش
• رقم الهاتف: ${mobicashMobile}
• رقم البطاقة: ${cardNumber}
• المبلغ المطلوب: ${originalAmount} د.ل
• قيمة الخدمة: ${calc.serviceFee} د.ل (${calc.feePercentage}%)
• المبلغ الإجمالي: ${calc.finalAmount} د.ل
• الحالة: في انتظار المعالجة
⏰ ${new Date().toLocaleString('ar-LY')}

📍 يرجى معالجة هذا الطلب يدوياً عبر نظام موبي كاش`;

            window.open(`https://api.whatsapp.com/send?phone=${SUPPORT_PHONE_PLAIN}&text=${encodeURIComponent(whatsappMessage)}`, '_blank');

            const statusMsg = `✅ تم إرسال الطلب إلى واتساب
• المبلغ: ${originalAmount} د.ل
• الرسوم: ${calc.serviceFee} د.ل
• الإجمالي: ${calc.finalAmount} د.ل`;
            
            setStatus('success', statusMsg, 'mobicashStatus');
            setTimeout(() => { 
                clearStatus('mobicashStatus');
                showPage(mainMenu);
                resetForm();
            }, 5000);
        });

        // دوال مساعدة لإعادة تعيين
        function resetTransactionUI() {
            clearStatus();
            clearStatus('confirmationStatus');
            clearStatus('mobicashStatus');
            document.getElementById('confirmationPin').value = '';
            currentSessionID = null;
            currentTransactionData = null;
        }

        function resetForm() {
            document.getElementById('customerMobile').value = '';
            document.getElementById('amountAdfa3ly').value = '';
            document.getElementById('amountDetailsAdfa3ly').classList.add('hidden');
            document.getElementById('mobicashMobile').value = '';
            document.getElementById('cardNumber').value = '';
            document.getElementById('amountMobicash').value = '';
            document.getElementById('amountDetailsMobicash').classList.add('hidden');
            hideReviewAdfa3ly();
            hideReviewMobicash();
            resetTransactionUI();
        }

    });
    </script>
</body>
</html>
