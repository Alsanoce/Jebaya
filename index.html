<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ØªØ¹Ø¨Ø¦Ø© Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root{
            --primary:#0066cc; --primary-dark:#004d99; --secondary:#ff6b00;
            --light:#f8f9fa; --dark:#333; --gray:#6c757d; --success:#28a745; --danger:#dc3545;
        }
        body{
            background: linear-gradient(135deg,#e6f2ff 0%,#cce5ff 100%);
            color:#333; line-height:1.6; min-height:100vh; padding:20px;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
        }
        .app-container{
            width:100%; max-width:400px; background:white; border-radius:20px;
            box-shadow:0 10px 30px rgba(0,0,0,0.15); overflow:hidden; margin:20px 0;
        }
        header{
            background: linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            color:white; padding:25px 20px; text-align:center; position:relative;
        }
        .logo-container{ display:flex; justify-content:center; align-items:center; margin-bottom:15px; }
        .logo{ width:70px; height:70px; background:white; border-radius:50%; display:flex; justify-content:center; align-items:center; margin-left:15px; box-shadow:0 5px 15px rgba(0,0,0,0.2); }
        .logo i{ font-size:35px; color:var(--primary); }
        h1{ font-size:22px; margin:10px 0 5px; }
        .subtitle{ font-size:14px; opacity:0.9; }
        .main-menu{ padding:20px; }
        .form-container{ padding:20px; }
        .form-group{ margin-bottom:20px; position:relative; }
        label{ display:block; margin-bottom:8px; font-weight:600; color:var(--primary-dark); }
        input, select, button { width:100%; padding:15px; border:1px solid #ddd; border-radius:10px; font-size:16px; }
        input:focus, select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 2px rgba(0,102,204,0.2); }
        .meter-input-container{ position:relative; }
        .validation-icon{ position:absolute; left:15px; top:50%; transform:translateY(-50%); font-size:18px; }
        .validation-icon.valid{ color:var(--success); }
        .validation-icon.invalid{ color:var(--danger); }
        .error-message{ color:var(--danger); font-size:12px; margin-top:5px; display:none; }
        .payment-options{ display:grid; grid-template-columns:1fr 1fr; gap:15px; margin:20px 0; }
        .payment-option{ background:var(--light); border:2px solid #ddd; border-radius:15px; padding:15px; text-align:center; cursor:pointer; transition:all 0.3s; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .payment-option.active{ border-color:var(--primary); background:#e6f2ff; box-shadow:0 5px 15px rgba(0,0,0,0.1); transform:translateY(-5px); }
        .payment-icon{ width:80px; height:80px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; overflow:hidden; background:white; padding:5px; }
        .payment-icon img{ width:100%; height:100%; object-fit:contain; }
        .payment-option h3{ font-size:16px; margin-bottom:5px; }
        .payment-option p{ font-size:12px; color:var(--gray); }
        .btn{ background: linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%); color:white; border:none; padding:16px; font-size:18px; font-weight:600; border-radius:10px; cursor:pointer; transition:all 0.3s; display:flex; justify-content:center; align-items:center; margin-top:10px; }
        .btn i{ margin-left:8px; }
        .btn:hover{ background: linear-gradient(135deg,var(--primary-dark) 0%,#003366 100%); transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled{ background:#ccc; cursor:not-allowed; transform:none; box-shadow:none; }
        .back-button{ position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.2); width:40px; height:40px; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer; }
        .hidden{ display:none; }
        footer{ text-align:center; padding:15px; color:var(--gray); font-size:14px; margin-top:auto; display:flex; flex-direction:column; align-items:center; gap:6px; }
        .amount-notice{ background:#e6f2ff; border:1px solid var(--primary); border-radius:8px; padding:10px; margin:10px 0; font-size:13px; text-align:center; color:var(--primary-dark); }
        .fee-notice{ background:#fff3cd; border:1px solid #ffeaa7; border-radius:8px; padding:12px; margin:15px 0; font-size:13px; text-align:center; color:#856404; }
        .amount-details{ background:#f8f9fa; border-radius:8px; padding:12px; margin-top:10px; font-size:14px; }
        .amount-breakdown{ display:flex; justify-content:space-between; margin-bottom:5px; }
        .final-amount{ font-weight:bold; color:var(--primary); border-top:1px solid #ddd; padding-top:8px; margin-top:8px; }
        .instructions{ background:#e6f2ff; padding:15px; border-radius:10px; margin-bottom:20px; border-right:4px solid var(--primary); }
        .instructions h3{ color:var(--primary); margin-bottom:10px; }
        .instructions ol{ padding-right:20px; }
        .instructions li{ margin-bottom:8px; font-size:14px; }
        .transaction-status{ padding:15px; border-radius:10px; margin:15px 0; text-align:center; display:none; }
        .status-success{ background:#d4edda; border:1px solid #28a745; color:#155724; }
        .status-error{ background:#f8d7da; border:1px solid #dc3545; color:#721c24; }
        .status-processing{ background:#e6f2ff; border:1px solid #0066cc; color:#004085; }
        .confirmation-page{ padding:20px; text-align:center; }
        .confirmation-input{ font-size:24px; text-align:center; letter-spacing:10px; font-weight:bold; }
        .review-box{ background:#f1f7ff; border:1px solid #d7eaff; border-radius:8px; padding:12px; margin-top:10px; font-size:14px; }
        .support-line{ font-size:14px; color:var(--gray); }
        .success-page{ padding:30px 20px; text-align:center; }
        .success-icon{ width:80px; height:80px; background:var(--success); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; }
        .success-icon i{ font-size:40px; color:white; }
        @media (max-width:480px){
            .app-container{ border-radius:15px; }
            header{ padding:20px 15px; }
            h1{ font-size:20px; }
            .form-container{ padding:15px; }
            .payment-icon{ width:70px; height:70px; }
            input, button{ font-size:15px; padding:12px; }
            .btn{ font-size:16px; padding:12px; }
            .payment-option{ padding:10px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <header>
            <div class="back-button hidden" id="backButton" title="Ø¹ÙˆØ¯Ø©">
                <i class="fas fa-arrow-right"></i>
            </div>
            <div class="logo-container">
                <div class="logo"><i class="fas fa-bolt"></i></div>
                <div>
                    <h1>Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</h1>
                    <p class="subtitle">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</p>
                </div>
            </div>
        </header>

        <div class="main-menu" id="mainMenu">
            <div class="instructions">
                <h3>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</h3>
                <ol>
                    <li>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (13 Ø±Ù‚Ù…Ø§Ù‹)</li>
                    <li>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</li>
                    <li>Ø§Ù…Ù„Ø£ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹</li>
                    <li>Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­</li>
                </ol>
            </div>

            <div class="form-group">
                <label for="meterNumber">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</label>
                <div class="meter-input-container">
                    <input type="text" id="meterNumber" placeholder="Ø£Ø¯Ø®Ù„ 13 Ø±Ù‚Ù…Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª" maxlength="13" inputmode="numeric" pattern="[0-9]{13}" required>
                    <div class="validation-icon hidden" id="meterValidationIcon"></div>
                </div>
                <div class="error-message" id="meterError">âŒ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 13 Ø±Ù‚Ù…Ø§Ù‹ ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 02680</div>
            </div>

            <h3 style="margin-bottom:15px; text-align:center; color:var(--primary);">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</h3>

            <div class="payment-options">
                <div class="payment-option" data-method="adfa3ly">
                    <div class="payment-icon"><i class="fas fa-mobile-alt" style="font-size:40px; color:#00a2ff;"></i></div>
                    <h3>Ø£Ø¯ÙØ¹ Ù„ÙŠ</h3>
                    <p>Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</p>
                </div>

                <div class="payment-option" data-method="mobicash">
                    <div class="payment-icon"><i class="fas fa-credit-card" style="font-size:40px; color:#6e3cba;"></i></div>
                    <h3>Ù…ÙˆØ¨ÙŠ ÙƒØ§Ø´</h3>
                    <p>Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</p>
                </div>
            </div>

            <button class="btn" id="continueButton" disabled><i class="fas fa-arrow-left"></i> Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
        </div>

        <!-- ØµÙØ­Ø© Ø£Ø¯ÙØ¹ Ù„ÙŠ -->
        <div class="form-container hidden" id="adfa3lyForm">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--primary);">Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø£Ø¯ÙØ¹ Ù„ÙŠ</h2>

            <div class="fee-notice"><i class="fas fa-info-circle"></i> <span>Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø­Ù†</span></div>
            <div class="amount-notice"><i class="fas fa-exclamation-circle"></i> <span>Ø£Ù‚Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„ØªØ¹Ø¨Ø¦Ø© 30 Ø¯ÙŠÙ†Ø§Ø±</span></div>

            <div class="form-group">
              <label for="customerMobile">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <input type="text" id="customerMobile" placeholder=" 09xxxxxxxx" required>
                <small style="color:var(--gray); font-size:12px;">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ</small>
            </div>

            <div class="form-group">
                <label for="amountAdfa3ly">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø±)</label>
                <input type="number" id="amountAdfa3ly" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº (30 Ø¯ÙŠÙ†Ø§Ø± ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰)" min="30" required>
                <div class="amount-details hidden" id="amountDetailsAdfa3ly">
                    <div class="amount-breakdown"><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„:</span><span id="enteredAmountAdfa3ly">0</span> Ø¯ÙŠÙ†Ø§Ø±</div>
                    <div class="amount-breakdown"><span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø© (<span id="feePercentageAdfa3ly">0</span>%):</span><span id="serviceFeeAdfa3ly">0</span> Ø¯ÙŠÙ†Ø§Ø±</div>
                    <div class="amount-breakdown final-amount"><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ¹Ù„ÙŠ:</span><span id="finalAmountAdfa3ly">0</span> Ø¯ÙŠÙ†Ø§Ø±</div>
                </div>
                <div class="review-box hidden" id="reviewBoxAdfa3ly"></div>
            </div>

            <div class="transaction-status" id="transactionStatus"><i class="fas fa-sync-alt fa-spin"></i> <span id="statusMessage">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...</span></div>

            <button class="btn" id="initiatePayment"><i class="fas fa-play-circle"></i> Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹</button>
        </div>

        <!-- ØµÙØ­Ø© ØªØ£ÙƒÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ -->
        <div class="confirmation-page hidden" id="confirmationPage">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--primary);">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h2>
            
            <div class="success-icon" style="background:#e6f2ff; margin-bottom:15px;">
                <i class="fas fa-mobile-alt" style="color:var(--primary); font-size:35px;"></i>
            </div>
            
            <h3 style="color:var(--primary); margin-bottom:15px;">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</h3>
            <p style="margin-bottom:25px; color:var(--gray);">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</p>

            <div class="form-group">
                <label for="confirmationPin">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (4 Ø£Ø±Ù‚Ø§Ù…)</label>
                <input type="text" id="confirmationPin" class="confirmation-input" placeholder="____" maxlength="4" inputmode="numeric">
            </div>

            <div class="transaction-status" id="confirmationStatus"></div>

            <button class="btn" id="confirmTransaction"><i class="fas fa-check-circle"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
        </div>

        <!-- ØµÙØ­Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ -->
        <div class="success-page hidden" id="successPage">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            
            <h2 style="color:var(--success); margin-bottom:15px;">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <p style="margin-bottom:20px; color:var(--gray);">ØªÙ… Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</p>

            <div class="review-box" id="successDetails" style="margin:20px 0;"></div>

            <button class="btn" id="whatsappButton" style="background:var(--success);">
                <i class="fab fa-whatsapp"></i> Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
            </button>
            
            <button class="btn" id="newTransaction" style="background:var(--primary); margin-top:10px;">
                <i class="fas fa-redo"></i> Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
            </button>
        </div>

        <!-- Ù…ÙˆØ¨ÙŠ ÙƒØ§Ø´ -->
        <div class="form-container hidden" id="mobicashForm">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--primary);">Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ù…ÙˆØ¨ÙŠ ÙƒØ§Ø´</h2>

            <div class="fee-notice"><i class="fas fa-info-circle"></i> <span>Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span></div>
            <div class="amount-notice"><i class="fas fa-exclamation-circle"></i> <span>Ø£Ù‚Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„ØªØ¹Ø¨Ø¦Ø© 30 Ø¯ÙŠÙ†Ø§Ø±</span></div>

            <div class="form-group">
                <label for="cardNumber">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
                <input type="text" id="cardNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" required>
            </div>

            <div class="form-group">
                <label for="amountMobicash">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø±)</label>
                <input type="number" id="amountMobicash" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº (30 Ø¯ÙŠÙ†Ø§Ø± ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰)" min="30" required>
            </div>

            <div class="review-box" id="reviewBoxMobicash" style="display:none;"></div>

            <button class="btn" id="submitMobicash"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
        </div>
    </div>

    <footer>
        <div>Â© 2025 Ù†Ø¸Ø§Ù… Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
        <div class="support-line">ğŸ“ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ: <a href="https://wa.me/218942381395" target="_blank" rel="noopener" style="color:var(--primary); text-decoration:none;">ÙˆØ§ØªØ³Ø§Ø¨ 0942381395</a></div>
    </footer>

    <script>
    // ======================
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø© (Google Apps Script Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… JSONP)
    // ======================
    class BankPaymentService {
        constructor() {
            this.scriptURL = 'https://script.google.com/macros/s/AKfycbwg_kGgmHi1Q9D86cq32RXO7tjDFPU7uE7O-CJWMDPIhuOW4HQ3g5Rp6rNRkjq50ldc/exec';
        }

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… JSONP Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† fetch Ù„ØªØ¬Ù†Ø¨ Ù…Ø´ÙƒÙ„Ø© CORS
        doPTrans(customerMobile, amount) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Date.now();
                const script = document.createElement('script');
                
                const url = `${this.scriptURL}?callback=${callbackName}&action=doPTrans&customerMobile=${encodeURIComponent(customerMobile)}&amount=${amount}`;
                script.src = url;
                
                window[callbackName] = (response) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (response && response.success) {
                        resolve(response.data);
                    } else {
                        reject(new Error(response?.error || 'Ø®Ø·Ø£ ÙÙŠ doPTrans'));
                    }
                };
                
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…'));
                };
                
                document.body.appendChild(script);
                
                // Timeout Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„'));
                    }
                }, 30000);
            });
        }

        onlineConfTrans(sessionID, confirmationPin) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Date.now();
                const script = document.createElement('script');
                
                const url = `${this.scriptURL}?callback=${callbackName}&action=onlineConfTrans&sessionID=${encodeURIComponent(sessionID)}&confirmationPin=${encodeURIComponent(confirmationPin)}`;
                script.src = url;
                
                window[callbackName] = (response) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (response && response.success) {
                        resolve(response.data);
                    } else {
                        reject(new Error(response?.error || 'Ø®Ø·Ø£ ÙÙŠ onlineConfTrans'));
                    }
                };
                
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…'));
                };
                
                document.body.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„'));
                    }
                }, 30000);
            });
        }

        saveToSheets(data) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Date.now();
                const script = document.createElement('script');
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ parameters
                let url = `${this.scriptURL}?callback=${callbackName}&action=saveToSheets`;
                Object.keys(data).forEach(key => {
                    url += `&${key}=${encodeURIComponent(data[key])}`;
                });
                
                script.src = url;
                
                window[callbackName] = (response) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (response && response.success) {
                        resolve(response.data);
                    } else {
                        reject(new Error(response?.error || 'Ø®Ø·Ø£ ÙÙŠ saveToSheets'));
                    }
                };
                
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…'));
                };
                
                document.body.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„'));
                    }
                }, 30000);
            });
        }
    }

    // ======================
    // Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
    // ======================
    document.addEventListener('DOMContentLoaded', function() {
        const mainMenu = document.getElementById('mainMenu');
        const adfa3lyForm = document.getElementById('adfa3lyForm');
        const mobicashForm = document.getElementById('mobicashForm');
        const confirmationPage = document.getElementById('confirmationPage');
        const successPage = document.getElementById('successPage');
        const backButton = document.getElementById('backButton');
        const continueButton = document.getElementById('continueButton');
        const meterNumberInput = document.getElementById('meterNumber');
        const meterValidationIcon = document.getElementById('meterValidationIcon');
        const meterError = document.getElementById('meterError');

        const bankService = new BankPaymentService();
        let currentSessionID = null;
        let selectedMethod = null;
        let isMeterValid = false;
        let currentTransactionData = null;

        const SUPPORT_PHONE_PLAIN = '218942381395';
        const SUPPORT_PHONE_DISPLAY = '0942381395';

        // ======= Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø© =======
        function setStatus(type, message, elementId = 'transactionStatus') {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = `transaction-status status-${type}`;
            const iconClass = (type === 'processing') ? 'sync-alt fa-spin' : (type === 'success' ? 'check-circle' : 'times-circle');
            el.innerHTML = `<i class="fas fa-${iconClass}"></i> <span id="statusMessage">${message}</span>`;
        }

        function clearStatus(elementId = 'transactionStatus') {
            const el = document.getElementById(elementId);
            el.style.display = 'none';
            el.className = 'transaction-status';
            el.innerHTML = '';
        }

        function showPage(page) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
            mainMenu.classList.add('hidden');
            adfa3lyForm.classList.add('hidden');
            mobicashForm.classList.add('hidden');
            confirmationPage.classList.add('hidden');
            successPage.classList.add('hidden');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            page.classList.remove('hidden');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
            if (page !== mainMenu) {
                backButton.classList.remove('hidden');
            } else {
                backButton.classList.add('hidden');
            }
        }

        function formatLibyanPhone(phoneRaw) {
            if (!phoneRaw) return '';
            let num = phoneRaw.replace(/\D/g,'');
            if (num.startsWith('0') && !num.startsWith('218')) {
                num = num.replace(/^0+/, '');
            }
            if (num.length === 9 && num.startsWith('9')) {
                return '+218' + num;
            }
            if (num.length === 12 && num.startsWith('218')) {
                return '+' + num;
            }
            if (num.startsWith('+')) return num;
            if (num.length === 10 && num.startsWith('09')) {
                return '+218' + num.slice(1);
            }
            return (num.length > 0 && !num.startsWith('+')) ? ('+' + num) : num;
        }

        function calculateServiceFee(amount) {
            let feePercentage = 10;
            if (amount >= 100) feePercentage = 5;
            const serviceFee = (amount * feePercentage) / 100;
            const finalAmount = amount + serviceFee;
            return { feePercentage, serviceFee: Math.round(serviceFee * 100) / 100, finalAmount: Math.round(finalAmount * 100) / 100 };
        }

        function showReviewAdfa3ly(mobile, amount) {
            const box = document.getElementById('reviewBoxAdfa3ly');
            const calc = calculateServiceFee(amount);
            box.innerHTML = `
                <b>Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙØ¹:</b><br>
                â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯: ${document.getElementById('meterNumber').value}<br>
                â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${mobile}<br>
                â€¢ Ø§Ù„Ù…Ø¨Ù„Øº: ${amount} Ø¯.Ù„<br>
                â€¢ Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø©: ${calc.serviceFee} Ø¯.Ù„ (${calc.feePercentage}%)<br>
                â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹: ${calc.finalAmount} Ø¯.Ù„
            `;
            box.classList.remove('hidden');
        }

        function hideReviewAdfa3ly() {
            const box = document.getElementById('reviewBoxAdfa3ly');
            box.classList.add('hidden');
            box.innerHTML = '';
        }

        function saveLastTransactionLocal(tx) {
            try {
                localStorage.setItem('lastTransaction', JSON.stringify(tx));
            } catch (e) {
                console.warn('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹', e);
            }
        }

        // ======= ØªØ­Ù‚Ù‚ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ =======
        function validateMeterNumber(number) {
            if (!number) return false;
            if (number.length !== 13) return false;
            if (!/^\d{13}$/.test(number)) return false;
            if (!number.startsWith('02680')) return false;
            return true;
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯
        meterNumberInput.addEventListener('input', function() {
            const value = this.value.replace(/\D/g,'');
            this.value = value;
            isMeterValid = validateMeterNumber(this.value);
            if (this.value.length > 0) {
                meterValidationIcon.classList.remove('hidden');
                if (isMeterValid) {
                    meterValidationIcon.className = 'validation-icon valid';
                    meterValidationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                    meterError.style.display = 'none';
                } else {
                    meterValidationIcon.className = 'validation-icon invalid';
                    meterValidationIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                    meterError.style.display = 'block';
                }
            } else {
                meterValidationIcon.classList.add('hidden');
                meterError.style.display = 'none';
            }
            updateContinueButton();
        });

        function updateContinueButton() {
            continueButton.disabled = !(isMeterValid && selectedMethod);
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
        paymentOptions.forEach(option => {
            option.addEventListener('click', function() {
                paymentOptions.forEach(op => op.classList.remove('active'));
                this.classList.add('active');
                selectedMethod = this.dataset.method;
                updateContinueButton();
            });
        });

        // Ø²Ø± Ø§Ø³ØªÙ…Ø±Ø§Ø±
        continueButton.addEventListener('click', function() {
            if (!isMeterValid) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¹Ø¯Ø§Ø¯ ØµØ­ÙŠØ­'); return; }
            if (!selectedMethod) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'); return; }
            
            if (selectedMethod === 'adfa3ly') {
                showPage(adfa3lyForm);
            } else {
                showPage(mobicashForm);
            }
        });

        // Ø²Ø± Ø±Ø¬ÙˆØ¹
        backButton.addEventListener('click', function() {
            showPage(mainMenu);
            resetTransactionUI();
            hideReviewAdfa3ly();
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ø£Ø¯ÙØ¹ Ù„ÙŠ
        document.getElementById('amountAdfa3ly').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            if (amount >= 30) {
                document.getElementById('enteredAmountAdfa3ly').textContent = amount;
                const calc = calculateServiceFee(amount);
                document.getElementById('feePercentageAdfa3ly').textContent = calc.feePercentage;
                document.getElementById('serviceFeeAdfa3ly').textContent = calc.serviceFee;
                document.getElementById('finalAmountAdfa3ly').textContent = calc.finalAmount;
                document.getElementById('amountDetailsAdfa3ly').classList.remove('hidden');

                const formattedMobile = formatLibyanPhone(document.getElementById('customerMobile').value);
                showReviewAdfa3ly(formattedMobile, amount);
            } else {
                document.getElementById('amountDetailsAdfa3ly').classList.add('hidden');
                hideReviewAdfa3ly();
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙŠØ¶Ø§Ù‹
        document.getElementById('customerMobile').addEventListener('input', function() {
            const amount = parseFloat(document.getElementById('amountAdfa3ly').value) || 0;
            if (amount >= 30) {
                const formattedMobile = formatLibyanPhone(this.value);
                showReviewAdfa3ly(formattedMobile, amount);
            }
        });

        // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ù„Ø£Ø¯ÙØ¹ Ù„ÙŠ
        document.getElementById('initiatePayment').addEventListener('click', async function() {
            const meterNumber = document.getElementById('meterNumber').value;
            const customerMobileRaw = document.getElementById('customerMobile').value;
            const customerMobile = formatLibyanPhone(customerMobileRaw);
            const amountInput = document.getElementById('amountAdfa3ly').value;
            const originalAmount = parseFloat(amountInput);

            if (!customerMobileRaw) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„'); return; }
            if (!originalAmount || originalAmount < 30) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 30 Ø¯ÙŠÙ†Ø§Ø±'); return; }

            // ØªØ­Ù‚Ù‚ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙˆØ±Ù…Ø§Øª
            if (!customerMobile.startsWith('+218') || customerMobile.length < 12) {
                alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù„ÙŠØ¨ÙŠ ØµØ§Ù„Ø­ (09xxxxxxxx)');
                return;
            }

            // Ø§Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            const calc = calculateServiceFee(originalAmount);
            const totalAmount = calc.finalAmount;

            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            currentTransactionData = {
                meterNumber,
                customerMobile,
                originalAmount,
                serviceFee: calc.serviceFee,
                totalAmount,
                feePercentage: calc.feePercentage
            };

            setStatus('processing', 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...');
            this.disabled = true;

            try {
                // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ DoPTrans Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… JSONP
                const result = await bankService.doPTrans(customerMobile, totalAmount);
                
                console.log('Ù†ØªÙŠØ¬Ø© DoPTrans:', result);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù…Ù† Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØµØ±Ù
                if (!result) {
                    throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ù…ØµØ±Ù');
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø¹Ø±ÙˆÙØ©
                if (result.includes('ACC') || result.includes('Error') || result.includes('Fail') || 
                    result.includes('Invalid') || result.includes('Not') || result.includes('Wrong')) {
                    throw new Error(result);
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ SessionID (Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ø¬Ø§Ø­)
                const hasSessionID = result.includes('SessionID') || /^\d+$/.test(result) || result.length > 5;
                
                if (!hasSessionID) {
                    throw new Error(result || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©');
                }

                // ÙÙ‚Ø· Ø¥Ø°Ø§ Ù†Ø¬Ø­Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ù†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
                currentSessionID = result;
                
                // Ù†Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ© ÙÙŠ Google Sheets ÙƒÙ€ pending
                await bankService.saveToSheets({
                    meterNumber,
                    paymentMethod: 'Ø£Ø¯ÙØ¹ Ù„ÙŠ',
                    customerMobile,
                    originalAmount: originalAmount,
                    serviceFee: calc.serviceFee,
                    totalAmount: totalAmount,
                    status: 'pending',
                    sessionID: result,
                    notes: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© - ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯'
                });

                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
                showPage(confirmationPage);
                clearStatus();

            } catch (error) {
                const errMsg = (error && error.message) ? error.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                
                console.log('Ø®Ø·Ø£ ÙÙŠ DoPTrans:', errMsg);

                // Ø­ÙØ¸ Ø§Ù„ÙØ´Ù„ ÙÙŠ Google Sheets
                try {
                    await bankService.saveToSheets({
                        meterNumber,
                        paymentMethod: 'Ø£Ø¯ÙØ¹ Ù„ÙŠ',
                        customerMobile,
                        originalAmount: originalAmount,
                        serviceFee: calc.serviceFee,
                        totalAmount: totalAmount,
                        status: 'failed',
                        sessionID: currentSessionID || '',
                        notes: `Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ DoPTrans: ${errMsg}`
                    });
                } catch (saveErr) {
                    console.warn('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ´Ù„ Ø¥Ù„Ù‰ Google Sheets:', saveErr);
                }

                let userMessage = errMsg;
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ø§Ù„Ù…ØµØ±Ù
                if (errMsg.includes('ACC')) {
                    userMessage = 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù…';
                } else if (errMsg.includes('PW') || errMsg.includes('Password')) {
                    userMessage = 'Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„';
                } else if (errMsg.includes('Balance') || errMsg.includes('Fund')) {
                    userMessage = 'Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯ÙØ¹';
                } else if (errMsg.includes('HTTP 500')) {
                    userMessage = 'Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
                } else if (errMsg.toLowerCase().includes('network') || errMsg.toLowerCase().includes('fetch')) {
                    userMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
                } else if (errMsg.toLowerCase().includes('parse')) {
                    userMessage = 'Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                }

                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£
                setStatus('error', userMessage);
                this.disabled = false;
            }
        });

        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (OnlineConfTrans)
        document.getElementById('confirmTransaction').addEventListener('click', async function() {
            const confirmationPin = document.getElementById('confirmationPin').value;

            if (!confirmationPin || confirmationPin.length !== 4) { 
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…'); 
                return; 
            }

            setStatus('processing', 'Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©...', 'confirmationStatus');
            this.disabled = true;

            try {
                const result = await bankService.onlineConfTrans(currentSessionID, confirmationPin);

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© OK -> Ø¹Ù…Ù„ÙŠØ© Ù†Ø§Ø¬Ø­Ø©
                if (result === 'OK' || result === 'Success' || result === 'OKAY') {
                    
                    // Ø­ÙØ¸ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Google Sheets
                    await bankService.saveToSheets({
                        meterNumber: currentTransactionData.meterNumber,
                        paymentMethod: 'Ø£Ø¯ÙØ¹ Ù„ÙŠ',
                        customerMobile: currentTransactionData.customerMobile,
                        originalAmount: currentTransactionData.originalAmount,
                        serviceFee: currentTransactionData.serviceFee,
                        totalAmount: currentTransactionData.totalAmount,
                        status: 'completed',
                        sessionID: currentSessionID,
                        notes: 'ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­'
                    });

                    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙƒØ£Ø­Ø¯Ø« Ù…Ø¹Ø§Ù…Ù„Ø©
                    saveLastTransactionLocal({ 
                        type: 'adfa3ly', 
                        ...currentTransactionData,
                        status: 'completed', 
                        sessionID: currentSessionID, 
                        ts: new Date().toISOString() 
                    });

                    // Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¬Ø§Ø­
                    const successDetails = `
                        <b>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø©:</b><br>
                        â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯: ${currentTransactionData.meterNumber}<br>
                        â€¢ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: Ø£Ø¯ÙØ¹ Ù„ÙŠ<br>
                        â€¢ Ø±Ù‚Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†: ${currentTransactionData.customerMobile}<br>
                        â€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ: ${currentTransactionData.originalAmount} Ø¯.Ù„<br>
                        â€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø©: ${currentTransactionData.serviceFee} Ø¯.Ù„ (${currentTransactionData.feePercentage}%)<br>
                        â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹: ${currentTransactionData.totalAmount} Ø¯.Ù„<br>
                        â€¢ ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ°: ${new Date().toLocaleString('ar-LY')}
                    `;
                    
                    document.getElementById('successDetails').innerHTML = successDetails;

                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                    showPage(successPage);

                } else {
                    // ÙÙŠ Ø­Ø§Ù„ Ø£ÙŠ Ø±Ø¯ ØºÙŠØ± OK -> Ø§Ø¹ØªØ¨Ø§Ø±Ù‡ ÙØ´Ù„ ØªØ£ÙƒÙŠØ¯
                    const note = `ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${result}`;
                    await bankService.saveToSheets({
                        meterNumber: currentTransactionData.meterNumber,
                        paymentMethod: 'Ø£Ø¯ÙØ¹ Ù„ÙŠ',
                        customerMobile: currentTransactionData.customerMobile,
                        originalAmount: currentTransactionData.originalAmount,
                        serviceFee: currentTransactionData.serviceFee,
                        totalAmount: currentTransactionData.totalAmount,
                        status: 'failed',
                        sessionID: currentSessionID,
                        notes: note
                    });

                    setStatus('error', `ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ØªØ­Ù‚Ù‚ ${result}`, 'confirmationStatus');
                    this.disabled = false;
                }

            } catch (error) {
                const errMsg = (error && error.message) ? error.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ£ÙƒÙŠØ¯';
                try {
                    await bankService.saveToSheets({
                        meterNumber: currentTransactionData.meterNumber,
                        paymentMethod: 'Ø£Ø¯ÙØ¹ Ù„ÙŠ',
                        customerMobile: currentTransactionData.customerMobile,
                        originalAmount: currentTransactionData.originalAmount,
                        serviceFee: currentTransactionData.serviceFee,
                        totalAmount: currentTransactionData.totalAmount,
                        status: 'failed',
                        sessionID: currentSessionID || '',
                        notes: `Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ OnlineConfTrans: ${errMsg}`
                    });
                } catch (saveErr) {
                    console.warn('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ´Ù„ Ø¥Ù„Ù‰ Google Sheets:', saveErr);
                }

                let userMessage = errMsg;
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ø§Ù„Ù…ØµØ±Ù
                if (errMsg.includes('ACC')) {
                    userMessage = 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù…';
                } else if (errMsg.includes('HTTP 500')) {
                    userMessage = 'Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
                } else if (errMsg.toLowerCase().includes('network') || errMsg.toLowerCase().includes('fetch')) {
                    userMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
                }

                setStatus('error', userMessage, 'confirmationStatus');
                this.disabled = false;
            }
        });

        // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
        document.getElementById('whatsappButton').addEventListener('click', function() {
            const whatsappText = encodeURIComponent(
`âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­

ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯: ${currentTransactionData.meterNumber}
â€¢ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: Ø£Ø¯ÙØ¹ Ù„ÙŠ
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†: ${currentTransactionData.customerMobile}
â€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ: ${currentTransactionData.originalAmount} Ø¯.Ù„
â€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø©: ${currentTransactionData.serviceFee} Ø¯.Ù„ (${currentTransactionData.feePercentage}%)
â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹: ${currentTransactionData.totalAmount} Ø¯.Ù„
â€¢ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø©: ${currentSessionID}
â€¢ ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ°: ${new Date().toLocaleString('ar-LY')}
-----------------
ğŸ‰ ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ - Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ÙƒÙ… Ø®Ø¯Ù…Ø§ØªÙ†Ø§`
            );

            window.open(`https://api.whatsapp.com/send?phone=${SUPPORT_PHONE_PLAIN}&text=${whatsappText}`, '_blank');
        });

        // Ø²Ø± Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
        document.getElementById('newTransaction').addEventListener('click', function() {
            resetForm();
            showPage(mainMenu);
        });

        // Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆØ¨ÙŠ ÙƒØ§Ø´ -> ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ + Ø­ÙØ¸ ÙÙŠ Google Sheets
        document.getElementById('submitMobicash').addEventListener('click', async function() {
            const meterNumber = document.getElementById('meterNumber').value;
            const cardNumber = document.getElementById('cardNumber').value.trim();
            const amountInput = document.getElementById('amountMobicash').value;
            const amount = parseFloat(amountInput);

            if (!cardNumber) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©'); return; }
            if (!amount || amount < 30) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 30 Ø¯ÙŠÙ†Ø§Ø±'); return; }

            // Ø§Ø­Ø³Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ§Ù„Ù…Ù„Ø®Øµ
            const calc = calculateServiceFee(amount);

            // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Google Sheets (status: pending)
            try {
                await bankService.saveToSheets({
                    meterNumber,
                    paymentMethod: 'Mobicash',
                    cardNumber,
                    amount,
                    status: 'pending',
                    sessionID: '',
                    notes: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù…ÙˆØ¨ÙŠ ÙƒØ§Ø´ - Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© ÙŠØ¯ÙˆÙŠØ©'
                });
            } catch (err) {
                console.warn('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ù…ÙˆØ¨ÙŠ ÙƒØ§Ø´ Ø¥Ù„Ù‰ Google Sheets:', err);
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨
            const whatsappMessage = `Ø·Ù„Ø¨ Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ%0A%0AğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:%0Aâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€%0Aâ€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯: ${meterNumber}%0Aâ€¢ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: Ù…ÙˆØ¨ÙŠ ÙƒØ§Ø´%0Aâ€¢ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${cardNumber}%0Aâ€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${amount} Ø¯ÙŠÙ†Ø§Ø±%0Aâ€¢ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø©: ${calc.serviceFee} Ø¯ÙŠÙ†Ø§Ø± (${calc.feePercentage}%)%0Aâ€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${calc.finalAmount} Ø¯ÙŠÙ†Ø§Ø±%0A%0Aâ° ${new Date().toLocaleString('ar-LY')}`;

            // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¯Ø¹Ù…
            window.open(`https://api.whatsapp.com/send?phone=${SUPPORT_PHONE_PLAIN}&text=${whatsappMessage}`, '_blank');

            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§
            saveLastTransactionLocal({ type: 'mobicash', meterNumber, cardNumber, amount, status: 'pending', ts: new Date().toISOString() });

            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¬Ø§Ø­ Ù…Ø¤Ù‚Øª
            setStatus('success', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Google Sheets (Ù…Ø¹Ù„Ù‚).');
            setTimeout(() => { clearStatus(); }, 2500);
        });

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
        function resetTransactionUI() {
            clearStatus();
            clearStatus('confirmationStatus');
            document.getElementById('confirmationPin').value = '';
            currentSessionID = null;
            currentTransactionData = null;
        }

        function resetForm() {
            document.getElementById('customerMobile').value = '';
            document.getElementById('amountAdfa3ly').value = '';
            document.getElementById('amountDetailsAdfa3ly').classList.add('hidden');
            document.getElementById('cardNumber').value = '';
            document.getElementById('amountMobicash').value = '';
            hideReviewAdfa3ly();
            resetTransactionUI();
        }

    });
     // ======================
// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹
// ======================
const paymentOptions = document.querySelectorAll('.payment-option');

paymentOptions.forEach(option => {
    option.addEventListener('click', () => {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙƒÙ„
        paymentOptions.forEach(o => o.classList.remove('active'));

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        option.classList.add('active');
        selectedMethod = option.dataset.method;

        // ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ø³ØªÙ…Ø±Ø§Ø±"
        continueButton.disabled = false;
    });
});

// ======================
// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³ØªÙ…Ø±Ø§Ø±
// ======================
continueButton.addEventListener('click', () => {
    if (!selectedMethod) return;

    mainMenu.classList.add('hidden');
    backButton.classList.remove('hidden');

    if (selectedMethod === 'adfa3ly') {
        adfa3lyForm.classList.remove('hidden');
    } else if (selectedMethod === 'mobicash') {
        mobicashForm.classList.remove('hidden');
    }
});

// ======================
// Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
// ======================
backButton.addEventListener('click', () => {
    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    adfa3lyForm.classList.add('hidden');
    mobicashForm.classList.add('hidden');
    confirmationPage.classList.add('hidden');
    successPage.classList.add('hidden');
    mainMenu.classList.remove('hidden');
    backButton.classList.add('hidden');
});   
    </script>
</body>
</html>
